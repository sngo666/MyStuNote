# 第一章 基础知识

* 在早期，Windows的主要部分只需要在3个动态链接库中实现，分辨代表Windows的三个子系统，Kernel、User和GDI

> Kernel(KERNEL32.DLL):操作系统核心功能服务，包括进程与线程控制，内存管理，文件访问等。所有内核对象都是跨进程的。每个内核进程在引用计数归零时关闭。同一个对象在不同进程里的句柄值是不同的。进程对象中也有个句柄表，索引此进程打开的所有内核进程。
> User(USER32.DLL):负责处理用户接口，包括输入设备，窗口和菜单管理等。  
> GDI(GDI32.DLL):图形设备接口，允许程序在屏幕和打字机上显示文本和图形。  

除了上述模块，Windows还提供了其他DLL以支持更多的功能，对象安全性、注册表操作的ADVAPI32.DLL、通用控件COMCTL32.DLL、公共对话框CCOMDLG32.DLL、用户界面外壳SHELL32.DLL和网络NETAPI32.DLL。

NT架构使用Unicode开发的，也就是说理论上使用ANSI编码的应用程序相对来说会占用更多的内存（需要调用响应的编码转换系统API）。NT内核主要是由c语言写的，辅以c++和极少数地方的汇编组成。
"NT 的开发团队通过使用面向对象的设计实现了高可维护性。再有，将操作系统的功能分成各个层也提高了可维护性。最上面的一层，也就是用户见到的操作系统层面，是子系统层。子系统提供系统调用接口来为外界提供应用程序编程接口。在系统调用接口层之下的是 NT 的 executive，executive 又建立在内核之上，而内核又依赖于硬件抽象层（HAL），硬件抽象层与硬件直接通讯。"
摘自网络。

* WOW64是Windows的子系统，使得大多数32位应用程序不进行修改便可以在64位系统上运行，WOW64既不支持16位应用程序，也不支持32位内核模式的设备驱动程序，只能加载32位的DLL，不能加载64位的原生DLL，同样，64位的原生进程也不能加载32位的DLL。

加载32位应用程序时，WOW64建立32位ntdll.dll所要求的的启动环境，将CPU模式切换至32位，并开始执行32位加载器。WOW64会对32位ntdll.dll调用重定向ntdll.dll(64位)。

* 消息机制

Windows是一个消息(Message)驱动式系统，消息系统提供在应用程序之间以及应用程序和操作系统之间的通讯方式，应用程序实现的功能由消息触发，通过对于消息的响应和处理完成。

消息具有非抢先性，无论事件的急与缓，总是按先后顺序到达队列。

* 虚拟内存

应用程序不会直接访问物理内存.
虚拟内存管理器通过虚拟内存访问请求控制所有的物理地址访问。
每个应用程序都有独立的4GB寻址空间，不同程序之间的地址空间是彼此隔离的。
DLL没有私有空间，总是被映射到应用程序的内存空间之中。


