# 文件、注册表和线程

写文件看似只是简单的操作，其中牵扯到最上层的调用，中间请求的分发，最后是文件系统对请求的处理。

## 文件操作

在高级语言编程中，操作文件一般是传递一个路径字符串，但是内核并不会直接接受一个字符串，使用者必须首先填写一个`OBJECT_ATTRIBUTE`,但是这个结构总是被`InitializeObjectAttributes`初始化。

```cpp
VOID InitializeObjectAttributes(
  //要初始化的OBJECT_ATTRIBUTE指针
  [out]          POBJECT_ATTRIBUTES   p, 
  //对象名称的字符串的指针
  [in]           PUNICODE_STRING      n,
  //定义标签
  [in]           ULONG                a,
  //在 ObjectName 参数中指定的路径名的根对象目录的句柄
  [in]           HANDLE               r,
  //指定在创建对象时应用于对象的安全描述符
  [in, optional] PSECURITY_DESCRIPTOR s
);
```

可以向a传递`OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE`实现方便快捷的文件访问，前者指的是文件不区分大小写，后者指定句柄只能在内核模式下访问。

### 打开和关闭文件

```cpp
NTSYSAPI NTSTATUS ZwCreateFile(
  //用于返回句柄的指针
  [out]          PHANDLE            FileHandle,
  //申请的权限
  [in]           ACCESS_MASK        DesiredAccess,
  //对象描述
  [in]           POBJECT_ATTRIBUTES ObjectAttributes,
  [out]          PIO_STATUS_BLOCK   IoStatusBlock,
  //一个指向64位整数的指针，定义文件初始大小
  [in, optional] PLARGE_INTEGER     AllocationSize,
  //控制新建立的文件属性，一般设置0或者FILE_ATTRIBUTE_NORMAL
  [in]           ULONG              FileAttributes,
  //设置共享访问参数
  [in]           ULONG              ShareAccess,
  //打开文件的意图
  [in]           ULONG              CreateDisposition,
  //打开选项，使用_SYNCHRONOUS_IO_NONALERT保证同步打开
  [in]           ULONG              CreateOptions,
  [in, optional] PVOID              EaBuffer,
  [in]           ULONG              EaLength
);

```

`IoStatusBlock`表示一个操作的结果，这种结构如下：

```cpp
typedef struct _IO_STATUS_BLOCK {
  union {
    NTSTATUS Status;
    PVOID    Pointer;
  };
  ULONG_PTR Information;
} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;
```

要注意的是对于路径的写法，不能直接写`"C:\\b.txt"`,因为盘符是一个符号链接对象，而应该写成`"\\??\\C:\\b.txt"`。

最后使用`ZwClose`关闭句柄，打开和关闭不需要在同一个进程中。

```cpp
NTSYSAPI NTSTATUS ZwClose(
  [in] HANDLE Handle
);
```