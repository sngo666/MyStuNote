# Paillier算法

对于了解密码学的同学来说，无论是同态加密(下称HE)还是本次要说的Paillier算法，都是很平常的知识，但是这里为了引出接下来的系统，我还是对这些方面稍作介绍。

根据支持的计算类型和支持程度，HE可以分为下三种类型:

* 半同态加密(PHE)：只支持加法或乘法中的一种运算。其中只支持加法运算的又叫做加法同态加密(AHE)。
* 部分同态加密(SWHE):可同时支持加法和乘法运算，但是支持的计算次数有限。
* 全同态加密(FHE):支持任意次数的加法和乘法运算。

由于FHE在计算有限次乘法后需要较复杂的去除噪声的操作，一般使用通用MPC协议通信开销较大。在复杂的计算场景中，单独使用某种通用方法通常得不到一个可用的落地方案。PHE诞生之后很快在隐私保护领域得到了大量使用，其高效且支持无限次加法或乘法的特点使其成为隐私计算的重要基本组件。在首次被提出后，学术界出现了多个支持PHE的方案，如RSA、GM、Elgama和Paillier等。

首先我们介绍加法PHE，其由三部分组成：密钥生成算法、加密算法和解密算法。此外还需要同态加算法和同态标量乘算法。下面对方案进行描述：

密钥生成部分：
1. 首先选择两个大素数p,q，满足gcd(pq, (p-1)(q-1)) = 1，且需满足p和q长度相等。
2. 计算n=pq以及λ=lcm(p-1, q-1),lcm为求最小公倍数，|n|表示n的比特长度
3. 随机选择整数g = Z(n^2^)
4. 定义函数L(x) = (x-1)/n,计算μ = (L(g^λ^ mod n^2^))^-1^ mod n
5. 公钥为(n, g), 私钥为(λ， μ)

加密部分：
1. 输入明文m，满足0<=m<n
2. 选择随机数r满足0<=r<n
3. 计算密文c=g^m^*r^n^ mod n^2^

解密部分:
1. 获得密文c
2. 计算明文消息m=L(c^λ^ mod n^2^)*μ mod n

同态加算法：
对于密文c1和c2 计算c = c1 * c2 mod n^2^

同态标量乘
对于密文c1和标量α, 计算c = c1^a^ mod n^2^

> 方案安全性可以归约到判定性合数剩余假设（DCRA），即给定一个合数n和整数z，判定z是否在n^2下是否是n次剩余是困难的。这个假设经过了几十年的充分研究，到目前为止还没有多项式时间的算法可以攻破，所以Paillier加密方案的安全性被认为相当可靠的。

## 后续优化方案

在后续的优化方案中，我们简要介绍使用Paillier-DJN、RT(中国剩余定理)加速模指数与使用预计算的方式进行优化。

a. 使用Paillier-DJN优化方案
随机选择x，计算h=-X^2^, hs = h^n^ mod n^2^，同时计算λ=(p-1)(q-1)/2，使私钥为λ，公钥为(n ,hs)
在计算密文的过程中，我们使用hs^a^替换原来算法的r^n^(a也是随机数)，可以实现相同的安全性，且比特长度缩减一半，加快了计算速度。

b. 使用中国剩余定理（CRT）加速模指数
在Paillier密码系统中，加密和解密的开销主要在模指数运算，在拥有私钥的情况下可以使用CRT将Zn^2^下的模指数运算转化到Zp^2^和Zq^2^上，从而加快解密效率。经测试，使用CRT之后的DJN私钥加密和解密性能提升了90%。

c. 使用预计算
由于在确定密钥参数后，Paillier的每次加密都是在固定的底数（fixed-base）下做模指数运算（如在DJN方案中，每次加密均需要在底数hs上计算模指数）。对于这种情况，可以使用预计算的方法，提前算好一些指数运算结果并保存，使得在线加解密的模指数计算转化为模乘运算。
将指数按bit拆分为0/1序列，对于指数的每一个bit，预计算底数^指数的相应结果，并存入列表中。当进行加密解密的模指数运算时，测试指数的每一bit是否为1，使用预计算的列表计算结果。
为了进一步提高效率，可考虑将多个bit设为一个窗口（window），按窗口大小w来展开多个指数bit，并进行预计算。经过这样的优化，根据开发需求修改w以获得最佳的性能/通信平衡。




