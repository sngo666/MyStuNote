# chapter_01 System architecture

## 要求和设计目标

1989年提出的windowsNT设计目标：

* 提供一个真正的32位、抢占式、可重入式虚拟内存操作系统。
* 在多个硬件体系结构和平台上运行。
* 在对称多处理系统上运行和扩展良好。
* 成为一个出色的分布式计算平台，既可以作为网络客户端，也可以作为服务器。
* 运行大多数现有的16位MS-DOS和Microsoft Windows 3.1应用程序。
* 满足政府对POSIX 1003.1合规性的要求。
* 满足政府和行业对操作系统安全性的要求。
* 通过支持Unicode，可以轻松适应全球市场。
(感觉大部分都是废话)

## 操作系统型号

在大多数多用户操作系统中，应用程序与操作系统本身是分开的。操作系统内核代码以特权处理器模式（在本书中称为内核模式）运行，可以访问系统数据和硬件。应用程序代码以非特权处理器模式（称为用户模式）运行，具有有限的可用接口集，对系统数据的访问权限有限，并且不能直接访问硬件。当用户模式程序调用系统服务时，处理器执行一条特殊指令，将调用线程切换到内核模式。当系统服务完成时，操作系统将线程上下文切换回用户模式，并允许调用方继续。

Windows与大多数UNIX系统类似，因为它是一个单片操作系统，因为大部分操作系统和设备驱动程序代码共享相同的内核模式保护内存空间。这意味着任何操作系统组件或设备驱动程序都可能损坏其他操作系统组件正在使用的数据。然而，正如您在第1章“概念和工具”中看到的那样，Windows通过WHQL等程序和KMCS强制执行来加强第三方驱动程序的质量和限制其来源，同时还结合了其他内核保护技术，如基于虚拟化的安全性、设备保护和超级保护功能，从而解决了这一问题。

WHQL: Microsoft Windows Hardware Quality ,微软的Windows 硬件设备质量实验室，是创建并管理用于测试系统和外围设备与微软Windows操作系统的硬件兼容性测试（HCK&HLK)工具。
KMCS: Kernal Mode Code Signing,仅允许加载由开发人员发布和经过数字签名的设备驱动程序，这些开发人员已经过为数不多的证书颁发机构 (CA) 之一的审查。

尽管Windows普遍使用对象来表示共享系统资源，但它并不是严格意义上的面向对象系统。为了便于移植，大多数内核模式的操作系统代码都是用C编写的。C编程语言不直接支持面向对象的构造，如多态函数或类继承。因此，Windows中基于C的对象实现借鉴了特定面向对象语言的特性，但并不依赖于这些特性。

## 体系结构概述

体系结构的简化版本如图所示。但这并非包含全部内容，比如网络组件和各种类型的设备驱动程序分层。

 ![Alt](./res/pic02_01.png#pic_center)

用户模式线程在专用进程地址空间中执行，系统进程、服务进程、用户进程和环境子系统每个都有自己的私有进程地址空间。
严格来说，系统管理程序仍然以与内核相同的CPU特权级别（0）运行，但由于它使用专门的CPU指令（英特尔上的VT-x，AMD上的SVM），它既可以将自己与内核隔离，也可以监视内核（和应用程序）。由于这些原因，你可能经常听到“R1”这个词(并不严谨)。

在Windows下，用户应用程序不会直接调用本机Windows操作系统服务。相反，它们通过一个或多个子系统动态链接库（DLL）。子系统dll的作用是将记录的函数转换为适当的内部（通常是未记录的）本机系统服务调用，这些调用主要在Ntdll.dll中实现。这种转换可能涉及也可能不涉及向为用户进程提供服务的环境子系统进程发送消息。

Windows的内核模式组件包括以下内容：

* Executive
  Windows executive包含基本操作系统服务，如内存管理、进程和线程管理、安全、I/O、网络和进程间通信。
* The Windows kernel
  这包括低级操作系统功能，如线程调度、中断和异常调度以及多处理器同步。它还提供了一组例程和基本对象，其余的执行人员使用这些例程和对象来实现更高级别的构造。
* Device drivers
  这既包括将用户I/O功能调用转换为特定硬件设备I/O请求的硬件设备驱动程序，也包括非硬件设备驱动，如文件系统和网络驱动程序。
* The Hardware Abstraction Layer (HAL)
  这是一层代码，将内核、设备驱动程序和Windows执行程序的其余部分与特定于平台的硬件差异（如主板之间的差异）隔离开来。
* The windowing and graphics system
  这实现了图形用户界面（GUI）功能（更广为人知的是Windows user和GDI功能），例如处理窗口、用户界面控件和绘图。
* The hypervisor layer
  这是由一个单独的组件组成的：系统管理程序本身。此环境中没有驱动程序或其他模块。也就是说，系统管理程序本身由多个内部层和服务组成，例如它自己的内存管理器、虚拟处理器调度器、中断和定时器管理、同步例程、分区（虚拟机实例）管理和分区间通信（IPC）等等。

 ![Alt](./res/pic02_02.png#pic_center)

## 可移植性

