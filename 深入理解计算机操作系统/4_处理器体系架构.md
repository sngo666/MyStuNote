# 第四章 处理器体系架构

* 使用Y86-64指令

Y86-64指令集是x86-64指令集的一个子集，只包含8字节整数操作，寻址方式和操作较少。
在地址计算中，我们不允许第二变址寄存器和任何寄存器值的伸缩。也不允许直接从一个内存地址传值给另外一个内存地址。同时，不允许将立即数传送到内存(指mov类)

* 指令编码

每条指令需要1到10个字节不等，这取决于需要哪些字段。每条指令的第一个字节表明该指令的类型。这个字节分为两部分，高四位是代码部分，低四位是功能部分，代码值为0~0xB。
在书中表中所示，15个程序寄存器每个都有一个相对应的范围在0到0xE之间的寄存器标识符（Y86-64与x86一样），不访问任何寄存器时使用ID值0xF。

有的指令需要`寄存器指示符字节`，指定一个或两个寄存器，但是如分支指令或者call指令不需要将寄存器作为操作数，就没有寄存器指示符字节，只需要对一个寄存器操作的指令，一般把第二个字节赋值为0xF。
还有一些指令需要一个附加的4字节`常数字`,可用作立即数数据，或是寄存器地址指示符的偏移量，以及分支指令和调用指令的目的地址（此为绝对地址，并非相对寻址方式）。
我们是用伪指令`.pos 0xXXXX`表明接下来的目标代码的起始地址是0xXXXX。
或者在使用此伪指令后在后面跟上标号`stack`用来标定栈，栈会从标定处向低内存方向生长。

* stat程序状态码

程序异常
对于Y86-64来说，程序员可见的状态还包括程序状态码`stat`，代码1表示AOK，程序正常执行。2表示HLT执行了一条`halt`指令。3 ADR表示处理器试图从一个非法的内存地址读或者写，超出程序限定地址的读写也会触发这条异常。最后一条4 INS表示遇到了非法的指令代码。

* Y86-64与x86-64的异同

Y86-64经常将常数加载到寄存器，因为在算术处理中不能够使用立即数（算术指令只允许使用寄存器作为操作数）。
`subq`指令同时还设置了条件码。

当执行`pushq %rsp`时，处理器的行为是不确定的，因为压入栈的指令会被同一条指令修改，Y86选择的策略与x86相同——存入执行本次压入栈之前的原始值。

* 逻辑设计和硬件控制语言HCL

现在，大多数设计都是使用硬件描述语言（HDL）来表达的，相比于HDL，HCL只表达硬件的控制部分，只有有限的操作集合，没有模块化。
将许多的逻辑门组成一个网，就能够构建一个计算块，我们称之为组合电路，每个逻辑门必须要保证至少连接下述之一：一个系统输入，某个存储器单元的输出，某个逻辑门的输出。
两个输出口不能连接在一条线路上，且网络不能存在回路。

由于组合电路是由一系列的逻辑门组成，它的属性会持续性地响应输入的变化，如果电路的输入变化了，经过短暂的延迟之后，结果也会跟着作出响应。
对于逻辑门来说，只有值0和1（不同于c语言）。

在HCL中，我们使用情况表达式描述多路复用函数，通用格式如下：
>
> ```c
> [
>   select1 : expr1;
>   select2 : expr2;
> ...
>   selectk : exprk;
> ]

每种情况i都有一个布尔表达式select i，表明什么时候选择这种情况，和一个整数表达式expri，表明得到的值。

组合电路从本质上来说并不能够存储任何信息，为了产生时序电路，也就是有状态且必须在这个状态上进行计算的系统，我们引入了按位存储信息的设备。存储设备都是由同一个设备控制的，时钟是一个周期性的信号。两类存储器设备：寄存器和内存。
寄存器的标识符作为地址存放在寄存器文件中，而这个文件存放在内存当中。

硬件寄存器在设计上有两个读端口，一个写端口。这样一个`多端口随机访问存储器`允许同时进行多个读和写操作。

* Y86-64的顺序实现。

实现了Y86-64处理器所需要的部件之后，我们描述一个成为SEQ的处理器系统。

处理一条指令包含许多操作，下面是关于各阶段的执行内容的简述。
`取指`（fetch）从内存读取指令字节，地址为程序计数器的值，从指令中抽取出指令指示符字节的两个四位部分，成为icode(指令代码)和ifun(指令功能)，如果需要，它可能取出一个寄存器指示符字节用以指示一或两个寄存器（rA，rB）操作数指示符，还有可能取出常数字。（顺便还会取出（计算）下一条指令的地址ValP）
`译码`（decode）从寄存器读入数据（rA->ValA,rB->ValB），需要时可以从%rsp读入数据。
`执行`（execute）根据ifun的值执行指明的操作(ValE),对于状态标志位的修改也是在这一阶段完成的,计算内存的有效引用地址，并对于条件跳转指令检验条件码和传送条件。
条件码寄存器有三个条件码位，ALU负责计算条件码的新值。当执行条件传送指令时，根据条件码的值和条件指令计算判断是否需要更新目标寄存器。
`访存`（memory）可以将数据写入内存，或者是从内存中读出数据。
`写回`（write back）最多写两个结果到寄存器文件。
`更新PC`（PC update）将程序计数器设置为下一条指令的地址。

Y86-64指令的原则：从不回读
处理器从来不需要为了完成一条指令的执行去读由该指令更新了的状态。
通俗来说，就是处理器是一个“活在当下”的工作状态，只操作所有当前现在的数值。

* 流水线的通用原理

流水线化系统的特点和通用属性：

1. 提高了系统的吞吐量，即单位时间内处理的对象个数，但是同时也会轻微增加工作延迟，及服务单个对象所需要花费的时间。
2. 宏观上，同时允许对多个对象操作，每个对象经历其自己的工作阶段。

将一个工作流程划分成多个工作阶段，接着在每个阶段安装响应的流水线寄存器，那么每条指令都会执行固定的阶段，且总执行时间会大大降低，代价是需要安装一些响应的硬件，并增大延迟。

缺点：不合理的流水线规划可能会导致过忙的工作阶段或者是过于闲置的工作阶段，会导致更大的延迟，应该根据延迟合理规划流水线工作阶段。
为了提高时钟频率，现代处理器通常采用很深的流水线。