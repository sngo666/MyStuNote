# 第三章 数据加密标准与替换算法

在过去三十年中大多数时间中，数据加密标准(DES)显然是最主流的分组密码。但是如今DES已经不再安全，使用DES连续三次对数据进行加密，这个过程称之为3DES，也可以得到非常安全的密码，由于DES是目前研究最透彻的对称算法，其设计理念给当前许多密码提供了一定的启发作用。

## DES

* 根据著名信息学家香农的理论，强加密算法都是基于已下两种本原操作：
1. 混淆，是一种使密钥与密文之间的关系尽可能模糊的加密操作，如今实现混淆常用的一个元素就是替换，这个元素在DES还是AES中都有使用。
2. 扩散，是一种为了隐藏明文的统计属性而将一个明文符号的影响扩散到多个密文符号的加密操作。最简单的扩散元素就是位置换，常用于DES中。通俗来说，就是让明文最小单位的改变能够尽可能影响最大数量的密文内容。

仅执行扩散的密码都是不安全的，比如移位密码，然而将扩散操作串联起来就可以建立一个更加强壮的密码，将若干加密操作串联起来的思想也是香农提出来的，这样的密码也叫作乘积密码，目前所有的分组密码都是乘积密码，因为它们都是由对数据重复操作的轮组成的。
现代分组密码都具有良好的扩散属性，从密码级别来说，这意味着改变明文中的1位将会导致平均一半的输出位发生改变，即第二位密文看上去与第一位密文完全没有关系。

* DES算法概述

DES是一种使用56位密钥对64位长分组进行加密的密码。DES是一种对称密码，其加密过程和解密过程都使用相同的密钥。与几乎所有现代分组加密一样，DES也是一种迭代算法那，DES对明文中每个分组的加密过程都包含16轮，且每轮的操作完全相同。而且所有子密钥ki都是从主密钥k中推导而来。

下面将讨论Festel网络，很多但不是全部现代分组密码都使用了Feistel网络(实际上AES不是Feistel密码)，Feistel的另一个优势是它的加密过程和解密过程几乎是完全相同。
将64位的明文x进行初始按位置换IP后，此明文会被分成L0和R0两个部分；然后将得到的32位左右的两部分输入到Feistel网络中，此网络包含16轮操作，右半部分R0将被送入函数f中，f的输出将会与32位的左半部分L0进行XOR。最后两部分进行交换，这个过程可以表示为：

> Li = R(i-1)  
> Ri = L(i-1) XOR f[R(i-1), ki]  

经过16轮后，均为32位的左半部分L16和右半部分R16将再次交换，逆初试置换是DES的最后一步操作。
f函数必须包括扩散和混淆两个基本属性，为了抵抗高级的分析攻击，设计f必须非常小心。

## DES的内部结构

* 初始置换与逆初始置换

初始置换与逆初始置换都是按位置换，按位置换可以看做是简单的交叉连接，其在硬件上很容易实现，软件上的实现却不是很快，初始置换和逆初始置换都并没有增加DES的安全性，尽管人们不是很清楚这两种置换存在的真正原理，但看上去它们的初衷是以字节形式排列明文密文以及位。初始置换和逆初始置换的表见书中所示。

* f函数

f函数在DES的安全性中扮演重要的角色，在第i轮中，f函数的输入为前一轮输出的右半部分Ri-1和当前密钥ki，f函数的输出用作XOR-掩码，用来加密左半部分输入位Li-1。

1. 首先将输入分成8个4位的分组，然后将每个分组扩展成六位，那么整体上就是将32位扩充为48位，这个过程在E-盒中执行，E-盒是一种特殊的置换，图中展示了如何扩展函数E的交换示例。
2. 32个输入位中共有16个输入位在输出中出现了两次，但是任意一个输入位都不会在同一个六位的分组中出现两次，扩展盒增加了DES的扩散行为。输入位会影响两个不同的输出位置。
3. 接着将扩展到的48位结果与轮密钥ki进行XOR操作，并将8个6位长的分组送入八个不同的替换盒中，这个替换盒也成S-盒，每个S-盒都有一个查找表，它将6位的输入映射位4位的输出，较大的查找表肯定会带来更好的加密效果，但是S-盒也会相应地变得更大，每个S-盒包含64项，可以表示为一个4行16列的表格，每项是一个4位的值。每个6位输入中最重要的位和最不重要的位将选择表行，而4个内部位则选择列。表中每个整数项0~15表示的是4位值对应的十进制值。从密码学强度来看，S-盒是DES的核心，也是该算法唯一的非线性元素，并且提共了混淆。下面简要介绍S-盒的选择动机。

> 每个S-盒都有6个输入位和4个输入位。  
> 任意一个输出位都不应该太接近于输入位的线性组合。  
> 如果输入位的最高位和最低位都是固定的，只有中间的4位是可变的，则每个可能的4位输出值都必须只出现一次。  
> 对于S-盒的两个输入，如果仅有一位不同，则输出必须至少有两位不同。  
> 对于S-盒的两个输入，如果只有中间的两位不同，则输出必须至少有两位不同。  
> 对于S-盒的两个输入，如果开头的两位不同，但最后两位相同，则输出必须不同。  
> 对任意有6位非零差分的输入对，32对输入中至多有8对相同的输出差分。  
> 8个S-盒对应的32位输出的冲突（零输出差异）只有在三个相邻的S-盒情况下才有可能。

4. 最后，32位的输出会根据表中所给出的置换P进行按位置换，与初始置换或者逆初始置换不同，置换P还会将扩散引入DES中，因为S-盒的4位输出都会进行置换，使得每一位在下一轮都会影响多个S-盒，保证在第五轮结束时，每个位都是每个明文和每个密钥位的函数，这种行为也称雪崩效应。
* 密钥编排
1. 密钥编排从原始的56位密钥中取得16个轮密钥ki，其中每个轮密钥ki都是48位，轮密钥也叫子密钥。DES的输入密钥通常是64位，每个第八位都作为前七位的奇校验位。任何情况下，这8个奇校验位都不是真的密钥位，也没有增加密码的安全性，所以可以说DES是一个56位的密码，而不是64位的。
2. 得到的56位密钥将分为C0和D0两部分，长度均为28的左右两部分将周期性地向左移动一位或两位(循环移位),移动的具体位数则取决于轮数i。
3. 在第1，2，9，16轮中，左右两部分向左移动一位，其他轮中左右两部分向左移动两位。循环移动的位置的总数为28，即C0=C16，D0=D16。
4. 为了得到48位的轮密钥，左右两部分需要再次根据PC-2(置换选择2)，表中忽略了8位，则只置换了56位。

密钥编排仅仅是一种系统化实现16轮置换的方法，实现起来非常容易。

## DES的解密

* DES的优势之一就是解密过程和加密过程在本质上其实是一样的。
1. 与加密相比，解密过程中只有密钥编排逆转了，第一轮需要子密钥16，以此类推。密钥编排算法在解密模式生成的轮密钥序列为k16，k15...k1。
   2。根据上面的结论D0=D16，C0=C16，很容易得到k16 = PC-2(PC-1(k)); k15 = PC-2(RS2(C0), RS2(D0))

2. 后面的轮密钥都是通过类似的方式得到，在解密模式中，第一轮不移位，2,9,16向右移动一位，其他轮左右两部分向右移动两位。
* Feistel网络中的解密

解密函数中每一轮操作都是DES函数加密中对应的逆。第一轮解密是最后一轮的加密，这是一个迭代的过程，在解密的最后进行逆初始置换，得到原始的明文，所以解密函数原理上和加密函数一样。

## DES的安全性

针对DES密码强度的批评主要围绕以下两个方面：

1. 密钥空间太小，即该算法很脆弱，易受蛮力攻击。

2. DES S-盒的设计准则是保密的，所有针对S-盒数学属性的分析攻击，只有设计者知道。
* 穷尽密钥搜索

定义:

> 输入： 至少一个明文密文对(x, y)  
> 输出： 满足y=DESk(x)的k  
> 攻击： 测试所有2^56个可能的密钥，直到以下条件成立  
> 对密文的解密得到明文。

找到错误密钥k的可能性很小，只有1/2^16的几率，如果攻击者想要排除这种可能性，必须还要再使用一个明密文对进行验证。

* 分析攻击

对于所谓的差分密码攻击(DC),攻击者需要2^47个明文-密文对，这是对于特意选择的结果，对于随机选择则需要2^55个，后来公布的线性分析攻击(LC)，对于LC而言，攻击者需要2^43个明密文对。

## DES替换算法

到目前为止，相当多的应用会选择AES作为加密算法，类似的安全算法如Mars,Serpent和Twofish都是非常安全的免费算法。

* 3DES和DESX

AES的替换算法或AES最终入围的是3DES，由三个连续的DES加密而成，可表示为：
`y=DESk1(DESk2(DESk3(x)))`
其中k1,k2,k3是三个不同的密钥。3DES可以抵抗当时所有的蛮力攻击和分析攻击。另一个版本是k2为解密过程，优点在于当k1=k2=k3时相当于执行一次DES，通常能支持老版本的DES。

* 轻量级密码PRESENT

轻量级密码一般指实现复杂度非常低的算法，尤其是指硬件实现方面，轻量级序列密码的一个例子就是Trivium，而最有希望的轻量级分组密码就是PRSENT，它是基于一个替换-置换网络(SP网络)。分组长度为64位，并且支持80位和128位两种长度的密钥。31轮的每一轮都由XOR操作完成的，而XOR操作引入一个轮密钥Ki，一个非线性替换层和线性按位置换。