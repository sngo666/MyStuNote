# GPU管线

## 概述

总的来说，可以分成几何处理阶段、光栅化阶段和像素处理阶段。每个阶段都有不同的可配置和可编程性。

![Alt](./res/GPU_pipeline.png#pic_center)

### Input Assembly

在开始整个管线之前，可以先说说Input Assembly(输入装配器)，用于组织数据的输入。

### Vertex Shader

管线始于vertex shader，是一个完全可编程的阶段。数据被阻止在一起，形成顶点集合和图元集合，除了模型的顶点坐标，还可以输入顶点的颜色、纹理坐标和表面法线。
需要注意的是，三角形虽然是能够描述一个面的最小的图元，但三角形本身并不代表一个面，其可能是一个潜在的曲面。而表面法线，就是实际用来补充描述曲面性质的，另外的，输入法线也能够有效减少额外计算法线的计算负荷。

MVP变换也发生于这一阶段，经过将模型坐标转换为世界坐标，将世界坐标系变换为摄像机视角的坐标，对视锥内的世界进行投影变换，最后通过视角变换转换为标准坐标系。
在Vulkan中，投影变换发生在Geometry Shader阶段之后，

### Tessellation

Tessellation(曲面细分)是基于摄像机视角，生成适当的三角形数量，对于距离较近的物体，使用较多的三角形进行渲染，对于距离较远的则相反。
对于DX中，其分为Hull shader(壳着色器)，tessellator(细分器)，domain shader(域着色器)。

壳着色器将输入的面片进行分析，首先告诉细分器需要生成多少个三角形以及如何对其进行配置；接下来处理每个控制点，最后这两部分的工作结果会被输出给域着色器。

### Geometry Shader

Geometry Shader(几何着色器)的输入是一个独立物体与其相关联的顶点，设计⽬的是对输⼊的顶点数据进⾏修改，或者是创建有限数量的副本。
它也可以⽤于⾼效的创建级联阴影贴图（cascaded shadow map，CSM），从⽽⽣成⾼质量的阴影。其他利⽤⼏何着⾊器的算法包括：从点数据中创建⼤⼩可变的粒⼦；沿着模型轮廓挤压出鳍⽚从⽽模拟⽑发渲染；找到物体的边缘从⽽⽤于阴影算法等。

### Pixel Shader

几何着色器之后，输出的片元会进行裁剪和设置。裁剪意味着一些三角形会被部分切割，进而生成更多的子三角形。
光栅化是一个固定的流程，通过每个片元的z值以及顶点的数值，完成到屏幕上的映射。

这里给出片元的定义:。三⻆形中部分与像素重叠、或者完全与像素重叠的部分被叫做⼀个⽚元(fragment).
某种程度上，片元也可以被理解为是像素(Games101)。在OpenGL中，像素着色器也被称为片元着色器(fragment shader)。

在编程中，顶点着⾊器程序的输出，在经过三⻆形（或者线段）插值之后，会成为像素着⾊器程序的输⼊。
一些其他的用于变成的数据也可以输入像素着色器中。

像素着色器无法读取相邻像素上的计算结果，

### Stream Out

流式输出的想法是在Shader Model 4.0中引⼊的，这些数据被发送到光栅化阶段之外，通过一个流进行输出。如果关闭光栅化器，那么管线就是一个纯粹的离线渲染器。

### Merge

在合并阶段，会将每个独立片元的颜色和深度进行组合，最终形成帧缓冲。在DX中叫做输出合并(output merger),OpenGL叫做逐样本操作(per-smaple operation)。

一个片元如果经过合并阶段最终不会显示在屏幕上，那么经过光栅化之后的像素着色器处理就是无意义的。许多GPU会在进行像素着色阶段之前对片元进行合并测试：对于片元的深度值进行可见性测试，这个操作被称为Early-Z。使用Early-Z可以显著提升渲染的性能表现。

合并阶段并非可编程的，但是可高度配置的，特别的对于颜色和透明度的处理。