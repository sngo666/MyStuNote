# Real Shading in Unreal Engine 4

要求：

* 实时性：高效地同时使用许多可见光源。
* 降低复杂度： 尽可能减少需要的参数，且能够互换使用基于图像的照明和分析光源，所有参数在所有光线类型中始终表现得一致。
* 符合直觉的接口。
* 感知线性：只能为每个像素着色一次。这意味着参数混合着色必须尽可能接近着色结果的混合。
* 易于掌握： 尽量避免对电介质和导体进行技术理解，并尽量减少创建基本物理合理材料所需的工作量。
* 稳定性： 很难错误地创建物理上不可信的材料，所有参数组合都应尽可能稳健和合理。
* 具有描述性： 基本着色模型需要具有足够的描述性，以覆盖现实世界中99%的材质。且所有可分层材质都需要共享同一组参数，以便在它们之间进行混合。
* 灵活性：其他项目和许可证持有者可能不具有相同的真实感目标，因此它需要足够灵活，以实现非真实感渲染。

## 渲染模型

光向量$\bold{l}$以及视角向量$\bold{v}$，依此定义微表面法线：

$$
\bold{h} = \frac{\bold{l} + \bold{v}}{|\bold{l} + \bold{v}|}
$$

### 漫反射BRDF

Burley的漫反射模型，与Lambertian漫射模型相比，只有很小的差异，无法证明额外的成本是合理的。任何更复杂的漫射模型都很难与基于图像或球面谐波照明一起有效使用。

$$
f(\bold{l}, \bold{v}) =  \frac{c_{diff}}{\pi}
$$

其中$c_{diff}$是材质的漫反射率。

### 微表面漫反射BRDF

$$
f(l, v) =  \frac{D(\bold{H})F(\bold{v}, \bold{h})G(\bold{l},\bold{v},\bold{h}))}{4(\bold{n}\cdot\bold{l})(\bold{n}\cdot\bold{v})}
$$

大多数没有以微平面形式具体描述的物理上合理的模型仍然可以被解释为微平面模型，因为它们具有微表面分布函数、菲涅耳因子和一些可以被视为几何阴影因子的附加因子。微平面模型和其他模型之间唯一真正的区别是它们是否包括来自微平面推导的显式$\frac{1}{4cos\theta_lcos\theta_v}$因子。

在实际的微表面模型中，还有一个附加的漫反射项$diffuse$，其代表一个未知形式的函数，通常使用Lambert漫反射来表示，下面简单介绍DFG。

#### Microfacet Distribution Function(D)

通过从测量材料的retroreflective实验中反映，绘制一组曲线并根据峰的高度将材料分为两组，高度被认为是表面粗糙程度，最高峰来自于钢铁，当曲线变得平缓，剩余部分便来自于漫反射。

相较于传统的反射模型，大多数材料在图表中表现的尾部更加长，这意味着从视觉上反射的逸散效果更加绵长，引入GGX基于这种想要更宽尾部的需求，尽管如此，依然无法捕捉到更加明显的辉光。

![Alt](./res/MERL_chrome.png#pic_center)

UE的选择同样基于这样的需求：

$$
D(\bold{h}) = \frac{\alpha^2}{\pi((\bold{n}\cdot\bold{h})^2(\alpha^2-1)+1)^2}
$$

其中$\alpha = Roughness^2$，该方程主要来源于GGX/Trowbridge-Reitz(1975)，并基于Disney的方式重新参数化了$\alpha$，尽管如此，其对于许多材料依然没有足够长的尾部。

简单介绍一下GTR(2012)，Trowbridge和Reitz将他们的分布函数以及其他几种分布与毛玻璃的测量值进行了比较。Berry(1923)的其他分布之一具有非常相似的形式，但指数为1而不是2，导致尾部更长。这表明了一个具有可变指数的更一般的分布，在这里引入，并被称为Generalized-Trowbridge-Reitz，或GTR:

$$
D_{Berry} = \frac{c}{\alpha^2cos^2\theta_h + sin^2\theta_h}
$$

$$
D_{TR} = \frac{c}{(\alpha^2cos^2\theta_h + sin^2\theta_h)^2}
$$

$$
D_{GTR} = \frac{c}{(\alpha^2cos^2\theta_h + sin^2\theta_h)^\gamma}
$$

在上述三类分布函数中，c是一个测量所得常数，$\alpha$是一个介于0~1之间用于描述粗糙程度的值，例如0代表一个绝对光滑分布反之1代表完全粗糙或均匀的表面分布。

初步拟合结果表明$\gamma$的典型值在1和2之间。有趣的是，$\gamma=32$的GTR等价于$\theta=2\theta_h$的Henyey-Greenstein相函数；$2\theta_h$的加倍可以看作是将分布从半球扩展到球体。

## Fresnel(F)

菲涅耳反射因子$F(\theta_d)$表示当光和视角矢量分开时镜面反射的增加，并预测所有光滑表面在掠入射时将接近100%镜面反射。对于粗糙表面，将无法实现100%的镜面反射，但反射率仍将变得越来越高。基本的Schlick近似表示为：

$$
F_{Schlick} = F_0 + (1 - F_0)(1 - cos(\bold{h}, \bold{l}))^5
$$

$F_0$为正常入射时的镜面反射率。对于电介质是消色差的，对于金属是彩色的（即着色的）。实际值取决于折射率。
因此F取决于$\theta_d$，即光矢量和微法线（即半矢量）之间的角度，而不是与表面法线的入射角。

值得注意的是，掠入射角附近的许多曲线的陡度大于菲涅耳效应预测的陡度。
这一观察结果是Torrance Sparrow(1967)微平面模型解释在更高入射角下出现的“非镜面峰值”的动机。请注意，微平面模型中的$\frac{1}{4cos\theta_lcos\theta_v}$在掠入射角处变得无限大，但这不是问题的原因(无论是在模型中还是在现实世界中)是因为微表面的阴影效应降低了掠反射。

![Alt](./res/Specular_F.png#pic_center)

尽管如此，G与因子的组合也有效放大了菲涅尔效应。
UE4的选择是使用了Schlick's approximation并使用球面高斯近似代替功率：

$$
F(\bold{v}, \bold{h}) = F_0 + (1 - F_0) 2^{-5.55473(\bold{v}\cdot\bold{h})-6.98316(\bold{v}\cdot\bold{h})}
$$

Disney方案对于菲涅尔因子的定义基于其对于物理上实现导致边缘更暗的问题的诉求，通过保证模型在光滑表面的漫菲涅尔阴影和粗糙表面的附加高光之间转换来达到想要的效果，具体来说:对于粗糙表面，光进入和离开围观表面特征的侧面，导致掠入射角处的折射增加。
此外，该方案忽略了漫射菲涅耳因子的折射率，并假设没有入射漫射损失。这允许直接指定入射漫反射颜色。通过Schlick-Fresnel近似，并修改掠射回射响应，使其达到由粗糙度而非零确定的特定值。

$$
f_d = \frac{baseColor}{\pi}(1 + (F_{D90} - 1)(1 - cos\theta_l)^5)(1 + (F_{D90} - 1)(1 - cos\theta_v)^5)
$$

其中：

$$
F_{D90} = 0.5 + 2roughness cos^2\theta_d
$$

对于光滑表面，该阴影在掠入射角下将入射漫反射率降低0.5，而对于粗糙表面，其响应增加高达2.5。

## Specular Geometric Attenuation(G)

当光线入射和出射时都会被遮挡一部分，这一部分的功能由镜面几何衰减描述，其用于计算最后出射的光线占据入射光线的比例:
在测量数据中分离G是困难的，因为它需要D和F因子的精确估计以及镜面与漫射的分离。然而，G对方向反照率(Albedo)的影响可以间接地看出。反照率是总反射能量与总入射能量的比值。因此，对于所有角度和波长，反照度都必须小于1。

大多数材料的方向反照率在前70度相对平坦，掠入射角的反照率与表面粗糙度密切相关。光滑的材料在75度左右略有增加，随后向90度下降。粗糙的表面通常会显著增加。值得注意的是，反照率值总体上相当低，少有材料的反照率超过0.3。

倘若完全忽略G和$\frac{1}{cos\theta_lcos\theta_v}$因子，成为"无G"模型，会导致掠入射角的相应过暗。
因此我们可以得知：G函数的选择对反照率有着深远的影响，反照率反过来又对表面外观有着深远影响。

$$
k = \frac{(Roughness + 1)^2}{8}
$$

$$
G_1(\bold{v}) = \frac{\bold{n}\cdot\bold{v}}{(\bold{n}\cdot\bold{v})(1-k) + k}
$$

$$
G(\bold{l}, \bold{v}, \bold{h}) = G_1(\bold{l})G_1(\bold{v})
$$

使用Schlick模型并令$k = \alpha/2$以更好拟合GGX的Smith模型，在这种情况下$\alpha = 1$Schlick与Smith完全匹配，并在其他状况下相当近似。在此基础上，使用$(Roughness+1)/2$以代替原有粗糙度用以降低热度，这样做的优点是能够尽量保证提升掠角的亮度。

继续看一看Disney的渲染方案：

通过使用GGX为Walter方案到处的G，并重新映射粗糙度以减少光泽表面的极端增益：

$$
\aleph_g = (0.5 + \frac{roughness}{2})^2
$$

由此，将原始粗糙度从$[0，1]$范围线性缩放到缩小的范围$[0.5，1]$。