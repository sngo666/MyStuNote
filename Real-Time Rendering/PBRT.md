# PBRT

主要是针对pbrt-v4的理论介绍，尽量不涉及代码讲解，尽管pbrt的代码技术构思之巧妙令人叹为观止，尚有太多可以学习的地方，不过这里仅仅限于对于其图形学思路以及实现的整理。

## Radiometry

### 基础量

#### Energy

能量以joules(J)作为单位，光子自光源发射而出，携带能量且具有特定的波长：

$$
Q = \frac{hc}{\lambda}
$$

$c$代表光速，299,472,458m/s.
$h$代表普朗克常数，$h \approx 6.626 \times 10^{-34}m^2kg/s$

#### Flux(lm)

通量表示单位时间内通过区域或者空间的能量，取微分时间内能量的极限，求出辐射通量。
顾名思义，其单位为$J/s$，也就是watts(W)

$$
\Phi = \lim_{\bigtriangleup t \rightarrow 0} \frac{\bigtriangleup Q}{\bigtriangleup t} = \frac{dQ}{dt}
$$

对于Flux的通俗描述可以理解成一个将光源完全包含的球体，在每个单位时间(对于计算机渲染过程来说)，该球面接收到光源发出的所有光子，以此作为描述通量的标准。当然，这也可以不是个球体，因为Flux本身并不会描述空间内任何距离或是区域上的特性。它仅仅代表光源在一个时间单位发出的全部能量。

#### Irradiance(lx)

Irradiance(辐照度) 和 Radiance(辐射度)分别描述Flux的方向特性以及方向和面积特性(粗浅理解)。

依然以环光源球体为例，假设两个不同层次(半径)的同心球体，光源位于球心。对于外层球体的单位区域($dA$)，单位时间内通过的光子数量必定小于内层球体单位区域上单位时间的光子通量。
道理很简单：每个单位时间内，光子(能量)是固定的，半径越大，表面积就越大，单位区域能捕获的光子就越少。

现在量化这个假设：

$$
E = \frac{\Phi}{4\pi r^2}
$$

对于一个微分区域A来说：

$$
E(p) = \lim_{\bigtriangleup A \rightarrow 0} \frac{\bigtriangleup \Phi(p)}{\bigtriangleup A} = \frac{d \Phi{p}}{dA}
$$

$p$用来代表一个点，因此$E(p)$用于描述点p每微分面积的辐照度(直射情况下)。
另一方面，光线到达物体表面的强度与物体表面和光线之间夹角的余弦成正比：

$$
E_2 = \frac{\Phi \cos \theta}{A}
$$

尽管我们不会主动提及Irradiance反映了光源在距离上的能量属性，因为这太片面了，而是用一个点上的微分面反应光源在该点上的能量属性，尽管可能理解上会比较笼统，但是定义上非常全面。

#### Intensity(cd)

当我们聚焦在光源上一个固定的角度散射的光子，这片光子会随着距离的拉长而散射在更大的区域中，但不变的是一旦角度固定，光子的能量是守恒的。这个角度被定义为立体角，是一个微分的角度，用于描述一个光源在某个方向上的强度。
可以想象：这个放射出去的光线呈一个微妙的锥形。

$$
I = \lim_{\bigtriangleup \omega \rightarrow 0} \frac{\bigtriangleup \Phi}{\bigtriangleup \omega} = \frac{d\Phi}{d\omega}
$$

虽然强度描述了方向的意义，但是和上面所假设的模型一样，这些只是用于描述并量化光源本身的性质，与环境并没有任何关系。

#### Radiance(nit)

辐亮度(Radiance)是描述光源的最重要的属性。在上文中，Intensity和Irradiance分别描述了光源在微分方向和微分区域上的能量性质，当然，也都是建立在微分时间单位基础上的。Radiance完成了这最后一步的组合。
可以说，Radiance是Intensity在描述光源在固定方向微分角的基础上，进一步描述在特定微分区域上的能量强度；也是Irradiance在微分区域上的能量性质的基础上，加入特定微分立体角的性质。所以，可以这么写：

$$
L(p, w) = \frac{d^2 \Phi}{d\omega dA^\perp} = \frac{dE_{\omega}(p)}{d\omega} = \frac{dI(\omega)}{dA \cos\theta}
$$

辐亮度是最基本的用于描述光强的属性，当给出辐亮度，意味着光源在特定方向和特定表面上的光强性质。另一方面，它能够保证光线在穿过真空时保持稳定。

#### 入射和出射光照函数

光与场景中的表面进行互动时，辐照函数在表面上往往不是连续的，对于表面的外层和里层也有可能是完全不同的。

使用$L_i(p, \omega)$描述光源出射点p的Radiance，函数的箭头朝向并不重要，一般来说，都是指向光源的。
使用$L_o(p, \omega)$描述在点p射出的Radiance。而对于表面的反面，则使用$-\omega$作为输入参数。

简单来说，这些函数只描述单面的性质。需要注意的是：

$$
L_o(p, \omega) = L_i(p, -\omega) = L(p, \omega)
$$

即：

$$
L^+ = L^-
$$

#### 光谱分布

到目前为止，所有辐射量的定义都没有考虑在波长上分布的变化，将光谱亮度$L_{\lambda}$定义为在无限削的波长间隔内的亮度极限$\bigtriangleup \lambda$

$$
L_{\lambda} = \lim_{\bigtriangleup \lambda \rightarrow 0} \frac{\bigtriangleup L}{\bigtriangleup \lambda} = \frac{dL}{d\lambda}
$$

所有这些光谱变体的单位都有一个附加系数$1/m$。
通过对描述人眼对于各种波长的相对灵敏度的光谱响应曲线V(A)积分，可以将每个光谱辐射量转换为响应的光度量。
最后我们描述亮度Y:

$$
Y = \int_{\lambda} L_{\lambda}(\lambda)V(\lambda) d\lambda
$$

## Radiometric Integrals

表示法向为n的点p处在一组方向$\Omega$的辐照度为：

$$
E(p, \bold{n}) = \int_{\Omega} L_i(p, \omega) |\cos \theta| d\omega
$$

通常而言，这个方向集合代表表面法线所朝向的半球面。

辐射量积分中的各种余弦因子常常会分散掉积分所想象要表达的内容(我觉得这句话就是字面上的意思，精简表达):

$$
E(p, \bold{n}) = \int_{H^2(\bold{n})} L_i(p, \omega) d \omega^{\perp}
$$

### 关于立体角

具体证明不多作说明，大概就是从球心出发，在球面上放射一道光线，这个光线与z轴呈现一个$\theta$角，并转动一个$d\theta$角，与此同时，在xOy平面转动一个$d\phi$角度，在球面上变动前后两个点作为对角的顶点形成一个近似矩形(这样思考)。因此根据两条边长求解面积。

$$
d\omega = \sin \theta d\theta d\phi
$$

因此，将入射能量表示为：

$$
E(p, \bold{n}) = \int_{0}^{2\pi} \int_{0}^{\pi / 2} L_i(p, \theta, \phi) \cos \theta \sin \theta d\theta d\phi
$$

### 面光源

假设存在一个输出恒定的四边形，计算其在p点处得到的辐照度,我们将方向微分转换为面积微分：

$$
d\omega = \frac{dA\cos\theta}{r^2}
$$

$r$表示从光源到点p处的距离，$\theta$表示微表面(光源)的法线和出射到点p之间的光线形成的夹角。这一转换可以被看作是，将这个表面的光照强度折损成朝向点p的强度，并考虑距离上的损失(想象球壳捕获能量，与球壳面积成比例，因此是$r^2$)
这个式子清晰反映了Intensity和Irradiance之间的关系，可见Irradiance相较于前者，性质上更”靠近“Radiance。

![Alt](./res/Reflection_Model.png#pic_center)

$$
E(p, \bold{n}) = \int_A L\cos \theta_i \frac{\cos\theta_o dA}{r^2}
$$

这里反映了一个表面射出能量到另一个表面的过程，探讨的模型不再仅仅限于一个表面和一个纯粹放射能量的光源。有这一基础，场景中的光照基本由这两种情况组成，光源到表面，再由表面到表面，然而这只是最简单的讨论。

## Surface Reflection

描述光反射机制有两个抽象：BRDF与BSSRDF
BRDF以相对简单的方式描述了地表反射，而后者概括了前者，并描述了半透明材料的光反射机制。

### BRDF

假设一束光线从方向角度$\omega_i$进入p点(所在的微表面，下略)，并在出射方向$\omega_o$被摄像机捕获，可以说这里的Irradiance被表示为：

$$
dE(p, \omega_i) = L_i(p, \omega_i) \cos \theta_i d\omega_i
$$

鉴于几何光学的线性假设(通俗理解为，入射的能量以一定比例损失)，可以表示为：

$$
f_r(p, \omega_o, \omega_i) = \frac{dL_o(p, \omega_o)}{L_i(p, \omega_i)\cos\theta_id\omega_i}
$$

对于$f_r$的理解要基于一个概念，就是其只反映一个入射方向与出射方向的Radiance的比例，并不代表出射方向的Radiance，也就是说，仅仅代表出射方向的一个微分，表面出射方向的Radiance应当由所有入射方向的Irradiance共同决定(在BRDF中)，这一点能够更好地理解公式的分子为什么是一个Radiance的微分。最后，如果对于为什么是Irradiance有疑问，答案很简单：因为入射点p。
需要特别说明的是，BRDF遵循两个特质：

1. 对于所有的入射和出射方向,$f_r(p, \omega_i, \omega_o) = f_r(p, \omega_o, \omega_i)$
2. 反射光的能量总是小于等于入射光的能量：

$$
\int_{H^2(\bold{n})} f_r(p, \omega_o, \omega') \cos \theta' d\omega' \le 1
$$

对于半球上指定出射方向，我们对于所有入射方向的Irradiance和BRDF函数进行积分计算，得出该表面的半球反射率:

<span id="rhohd">

$$
\rho_{hd}(\omega_o) = \int_{H^2(\bold{n})} f_r(p, \omega_o, \omega_i) |cos\theta_i|d\omega_i
$$

</span>

这个特质同时表明了另一件事：在固定的某个入射和出射方向上，其BRDF并不一定小于等于1.
关于BRDF最后要表示是，对于hemispherical-hemispherical reflectance，也就是半球-半球反射率，对于微表面所在半球面，分别考虑所有入射方向和所有出射方向的积分，以求解$\rho_{hh}$:

$$
\rho_{hh} = \frac{1}{\pi} \int_{H^2(\bold{n})}\int_{H^2(\bold{n})}f_r(p, \omega_o, \omega_i) |\cos \theta_o\cos\theta_i|d\omega_i d\omega_o
$$

bidirectional transmittance distribution function(BTDF)描述了透射光的分布，使用$f_t(p, \omega_o, \omega_i)$，需要注意的是，$\omega_i$与$\omega_o$位于点p周围的相反半球，此外，BTDF不满足上述的互易性。

bidirectional scattering distribution function(BSDF)是BRDF与BTDF相结合的产物：

$$
dL_o(p, \omega_o) = f(p, \omega_o, \omega_i) L_i(p, \omega_i) |cos\theta_i| d\omega_i
$$

最后，鉴于透射方程的加入，可以完成基于整个球体的反射方程：

$$
L_o(p, \omega_o) = \int_{S^2}f(p, \omega_o, \omega_i) L_i(p, \omega) |cos \theta_i| d\omega_i
$$

### BSSRDF

bidirectional scattering surface reflectance distribution function (BSSRDF)用于描述亚表面光传输的材料散射形式，对于分布函数$S(p_o, \omega_o, p_i, \omega_i)$描述了入射点$p_i$以及角度$\omega_i$的Flux在对应的出射点恶化出射角度的Radiance之间的关系。

$$
S(p_o, \omega_o, p_i, \omega_i) = \frac{dL_o(p_o, \omega_o)}{d\Phi(p_i, \omega_i)}
$$

很明显，随着两点之间距离的递增，$S$也许会以一个非常陡峭的倍率下降。
BSSRDF与BRDF最大的区别在于，前者发生在一个点上，而后者明显不是，这意味着积分运算会复杂许多：

$$
L_o(p_o, \omega_o) = \int_A\int_{H^2(\bold{n})} S(p_o, \omega_o, p_i, \omega_i)L_i(pi, \omega) |\cos\theta_i| d\omega_idA
$$

在计算云或者烟雾中的光线传播基于同样的效应。

## Light Emission

原子在高于绝对零度的情况下运动，带有电荷的原子粒子运动导致发射一定波长的电子辐射，基于此诞生了许多不同种类的光源。

Luminous efficacy(光效)衡量了将功率转化为可见光的效率，对于人类来说，不可见光几乎没有价值。其表现为发射的光度量和辐射量(在所有波长发射的总功率)的比率：

$$
\frac{\int \Phi_e(\lambda) V(\lambda) d\lambda}{\int\Phi_i(\lambda)d\lambda}
$$

$V(\lambda)$表示光谱响应曲线。
光效也可以被定义为表面上某一点的发光亮度与Irradiance的比值。

### Blackbody Emitters

黑体表示为尽可能有效的将能量转换为电磁辐射，这在现实中不可能被实现，但是可以用来表示发射波长和温度的函数关系。黑体意味着完美吸收了所有的入射能量，并不反射任何能量，普朗克定律给出了黑体发出的辐射率和波长的函数关系：

$$
L_e(\lambda, T) = \frac{2hc^2}{\lambda^5(e^{hc/\lambda k_bT}-1)}
$$

$k_b$表示玻尔兹曼(Boltzmann)常数$1.3806488\times10^{-23}J/K$，$K$表示温度。理想状态下，黑体向所有方向均匀辐射。

随着温度的升高，更多的发射光处于可见频率内(380nm至780nm之间)，并且发射总能量有迅猛的增长。
最后，要注意单位统一。

* 非黑体辐射

基尔霍夫定律描述了非黑体的辐射，任何频率下的发射Radiance分布等于完美黑体在该频率下的Radiance乘以在该频率上被物体吸收的入射辐射的分数，吸收的辐射率等于1减去反射的量。

$$
L'_e(T, \omega, \lambda) = L_e(T, \lambda)(1 - \rho_{hd}(\omega))
$$

普朗克定律给出了$Le$，$\rho_{hd}(\omega)$给出了半球方向的反射率，正是[前文](#rhohd)已经给出的。

Stefan–Boltzmann定律给出了在点p的辐射出射度：

$$
M(p) = \sigma T^4
$$

$\sigma$代表了Stefan–Boltzmann常数$5.67032\times Wm^{-2}K^{-4}$
可以注意到，所有频率上的总发射以$T^4$的速率倍增，这意味着温度加倍会使发射的总能量增加16倍。

如果发射器的发射光在某一个温度下与黑体分布相似，可以说发射器具有相应的色温。找到具体色温的方法取发光器最高的波长，使用Wien’s displacement定理给定温度下合体发射最大值的波长：

$$
\lambda_{max} = \frac{b}{T}
$$

$b$代表了Wien’s displacement常数 $2.8977721 \times 10^{-3}mK$
白炽灯的色温一般在2700K左右，卤钨灯的色温在3000K左右，荧光灯的亮度范围在2700K到6500K之间，温度超过5000K被描述为冷，而2700~3000K被描述为暖。

* 其他标准

国际委员会CIE制定了另外一套对于光发射分布的定义。
标准光源A对应于黑体辐射体约2856K。
其他的在有需要时再作补充。

## Representing Spectral Distributions

现实中的光谱会很复杂，为了能够正确表示包含各种复杂光谱的场景图像，必须要让渲染器有效准确表示光谱分布，从定义常数到表示光谱，使用nm作为表示波长的基本单位。
一般来说，pbrt只会关注肉眼能够捕捉到的光谱波长，也就是大约400~380之间。可以使用一组基函数和对应的系数去表示SPD(Spectral power distributions)，也可以使用一组离散的点，并藉由线性插值完成SPD的存储和再现。

### color

颜色感知的三刺激理论认为，所有可见光谱分布都可以使用三个标量值准确地表示给人类观察者。其基础是眼睛中有三种类型的感光视锥细胞，每种细胞对不同波长的光敏感。

对于光谱分布$S(\lambda)$和三个刺激匹配函数$m_{1,2,3}(\lambda)$相乘得到相应的刺激值$v_i$

$$
v_i = \int S(\lambda)m_i(\lambda)d\lambda
$$

匹配函数给出了一个颜色空间，通过三刺激值的3D向量空间：两个光谱之和的三刺激值由它们的三刺激值和与已缩放的光谱相关联的三刺激值之和给出。
给定一个光谱分布函数$S(\lambda)$，其xyz色彩空间坐标通过与对应的光谱匹配曲线的积来计算

$$
x_\lambda = \frac{1}{\int_\lambda Y(\lambda)d\lambda}\int_\lambda S(\lambda)X(\lambda) d\lambda\\
y_\lambda = \frac{1}{\int_\lambda Y(\lambda)d\lambda}\int_\lambda S(\lambda)Y(\lambda) d\lambda\\\
z_\lambda = \frac{1}{\int_\lambda Y(\lambda)d\lambda}\int_\lambda S(\lambda)Z(\lambda) d\lambda\\
$$

CIE $Y(\lambda)$三刺激曲线与用于定义光度量的$V(A)$光谱响应曲线成比例：

$$
V(A) = 683 Y(A)
$$

对于两个光谱的简单1D积分，通过黎曼积分来计算：

$$
\int^{\lambda_{max}}_{\lambda_{min}} f(\lambda)g(\lambda) \approx \sum^{\lambda_{max}}_{\lambda = \lambda_{min}} f(\lambda)g(\lambda)
$$

关于色彩空间的具体理论，可以查看虎书的相关章节(Chapter.19)

## Camera and Film

相机镜头引入各种像差以影响生成的图像，渐晕(vignetting)可以使图像的边缘变暗，这是因为达到胶片或者传感器边缘的光线比到达中心的光线少，透镜也会引起针垫(pincushion)或筒形(barrel)变形(distortion)，从而导致直线成像为曲线。
虽然镜头设计师在设计中尽量减少像差，但它们仍然可以对图像产生有意义的影响。

相机捕捉到光线后，传感器会对其进行测量。
传统胶片使用化学方法测量光线，而大多数现代相机则使用固态传感器，传感器分为像素，每个像素都会计算一段时间内到达一定波长范围的光子数量。精确模拟传感器测量光线的辐射度(radiometry)是模拟图像形成过程的重要部分。

本章介绍两种胶片实现。

### 相机坐标空间

我们现在将介绍四个额外的坐标空间，对象空间，相机空间，相机世界空间和渲染空间。

* 对象空间:这是定义几何原语的坐标系统。例如，pbrt中的球体被定义为以其对象空间的原点为中心。
* 世界空间:虽然每个原语都有自己的对象空间，但场景中的所有对象都与单一的世界空间相关。从对象到世界的转换决定了每个对象在世界空间中的位置。世界空间是定义所有其他空间的标准框架。这些是图形学的常识，就不做多赘述。
* 相机空间:摄像机被放置在场景中的某个世界空间点上，具有特定的观看方向和方向。这个相机定义了一个新的坐标系统，它的原点在相机的位置。该坐标系的z轴映射到观测方向，y轴映射到向上方向，对于此不同的API可能会有不同的定义。
* 相机世界空间:与相机空间一样，这个坐标系统的原点是相机的位置，但它保持世界空间的方向(即，与相机空间不同，相机不一定向下看z轴)。
* 渲染空间:这是为了渲染而将场景转换成的坐标系统。

简而言之，它可能是世界空间、相机空间或相机-世界空间。
当生成光线并开始追踪时，可能从相机空间开始，然后将光线转化为世界空间，在哪里执行所有随后的光线相交和阴影计算。这样看会导致远处的物体渲染因为浮点数的误差没有足够的精度来表示所看到的部分场景。

使用"相机-世界空间"进行渲染可以获得两全其美的效果：摄像机位于原点，场景也会相应地平移。不过，旋转不会应用于场景几何体，从而为加速结构保留了良好的边界框。

### 关于正交投影和透视投影

这也是老生常谈的问题了，具体可以去看虎书。

此外，在pbrt中对于像差模拟的效果在MVP变换阶段就完成，在变换使用聚焦距离、光圈大小等附加参数，以模拟真实的透镜系统对焦效果。这是下一节着重介绍的。

### 薄透镜模型和景深

理想的针孔相机只允许光线通过一个点到达胶片，这在物理上是不可实现的;
虽然有可能制造具有极小光圈的相机来接近这种行为，但较小的光圈允许相对较少的光到达胶片传感器。由于光圈小，需要长时间的曝光来捕捉足够的光子以准确捕捉图像，这反过来又会导致场景中物体在相机快门打开时移动而产生模糊。真正的相机有镜头系统，通过一个有限大小的光圈将光线聚焦到胶片上。
相机设计师(以及使用光圈可调相机的摄影师)面临着一个权衡:光圈越大，到达胶片的光线就越多，所需的曝光时间就越短。然而，镜头只能聚焦在一个平面上(焦平面)，场景中的物体离这个平面越远，就越模糊。光圈越大，这种效果就越明显。

对于目前介绍的简单相机模型，我们可以应用光学中的经典近似，即薄透镜近似，用传统的计算机图形投影模型来模拟有限孔径的影响。
薄透镜近似将光学系统建模为具有球面轮廓的单透镜，其中透镜的厚度相对于透镜的曲率半径较小。在薄透镜近似下，平行于光轴并穿过透镜的入射光线聚焦在透镜后面的一点，称为焦点。焦点在透镜后面的距离f是透镜的焦距。如果将胶片平面放置在与镜头后面的焦距相等的距离上，那么无限远的物体将被聚焦，因为它们成像到胶片上的一个点。

对于距离一个焦距$f$的薄透镜在景深$z$的点，高斯透镜方程表示物体到透镜的距离以及透镜到改点的像的距离：

$$
\frac{1}{z'} - \frac{1}{z} = \frac{1}{f}
$$

在$z = -\infty$有$z' = f$

我们可以用高斯透镜方程求解透镜到将聚焦平面设置在某z处的薄膜之间的距离，即焦距:

$$
z' = \frac{fz}{f+z}
$$

不在对焦平面上的点会成像为胶片平面上的一个圆盘，而不是单个点。这个圆盘的边界称为混淆圈(circle of confusion)。混淆圈的大小受光线通过的光圈直径、焦距以及物体与镜头之间的距离的影响。虽然混淆圈的半径只有一个深度为零，但附近深度范围的混淆圈足够小，因此它们看起来仍在焦点内。
对焦的深度范围称为景深。

高斯透镜方程提供了我们计算混淆圈的思路，给定一个焦距为f的透镜位于距离$z_f$，投影平面$z'_f$，给定一个点位于深度z，高斯透镜方程给出了该点的距离$z'$，显然，当$z \neq z'$，这个点不是薄膜平面的前面就是后面.
混淆圈的直径由透镜和薄膜之间透射形成的圆锥的交点给出：

 ![Alt](./res/Gaussian_lens.png#pic_center)

$$
\frac{d_1}{z'} = \frac{d_c}{|z' - z'_f|}
$$

应用高斯透镜方程，用场景深度来表示结果,也就是：

$$
d_c = |\frac{d_1f(z - z_f)}{z(f+z_f)}|
$$

显然，混淆圈的直径和镜头直径成正比，镜头直径通常使用$f$表示，即用焦距的分数表示直径：

$$
d_1 = f/n
$$

此外，需要指出的是，在焦平面前的混淆圈直径增长速度，远快于在焦平面后生成的混淆圈直径增长速度。

在光线追踪器中对薄透镜进行建模非常简单：只需在透镜上选择一个点，然后找到合适 的光线从该点在透镜上开始，使聚焦平面上的物体在胶片上对焦。
因此，投射式摄影机需要两个额外的景深参数：一个是镜头光圈的大小$d_1$，另一个是焦距$f$。
通常需要为每个图像像素追踪许多光线，以便对镜头进行充分采样，从而获得平滑的散焦模糊效果。

对于硬光栅来说，可能不需要这么麻烦的逐像素采样流程，可以选择视效类似的Bokeh模糊算法达到相同的效果。

### 球形摄像机

球形摄像机并非从投影变换而来，因为其映射并非遵从线性变换，无法使用单一矩阵进行捕捉。

### 胶片与成像

当摄影机的放映或镜头系统在胶片上形成场景图像后，有必要模拟胶片如何测量光线以创建渲染器生成的最终图像。
本节首先概述如何在胶片上测量光线的辐射度，然后继续讨论如何将光谱能量转换为三刺激颜色(通常为RGB)。

在对真实影像形成过程进行模拟的基础上，我们还需要对胶片或相机传感器测量的辐射 量进行更细致的定义。从镜头后部射向胶片的光线携带着场景的辐射(radiance)。因此，从胶片平面上的某一点看，有一组辐射入射的方向。离开镜头的辐射分布受胶片上的点所看到的散焦模糊程度的影响。

给定一组入射辐射函数，我们可以定义薄膜平面上一点的辐照度(irradiance)，通过上文提到的公式，将立体角积分转化为面积积分，并转化为透镜元件相切的平面面积$A_e$:

![Alt](./res/Irradiance_In_Lens.png#pic_center)

$$
E(p) = \int_{A_e} L_i(p, p')\frac{|cos\theta cos\theta'|}{||p' - p||}dA_e
$$

显然，我们需要的是垂直射入某个透镜点的辐射，当薄膜平面平行于透镜平面时，$\theta = \theta'$，此外还有p与p'之间的距离等于从薄膜平面到透镜的轴向距离(垂直距离)除以$cos \theta$这一事实：

$$
E(p) =\frac{1}{z^2} \int_{A_e} L_i(p, p')|cos^4\theta|dA_e
$$

现在我们明白了，影响辐射量的关键在于轴向距离和角度，对于胶片范围较大的相机来说，角度会显著降低辐射度，这一因素也导致了渐晕的严重化，大多数现代数码相机都使用预设的校正因子来校正这种效果，其用于增强传感器边缘的像素值效果。
假定我们按下快门，对胶片上的辐照度进行积分，得到辐射曝光(radiant exposure)后，计算每面积能量的辐射单位：

$$
H(p) = \frac{1}{z^2}\int^{t_1}_{t_0}\int_{A_e} L_i(p, p', t')|cos^4 \theta|dA_edt'
$$

radiant exposure也可以被称为fluence，测量某一点的fluence，接受到的能量与快门打开的时间长短有直接关系。
我们对于传感器像素区域进行积分：

$$
J = \frac{1}{z^2} \int_{A_p}\int^{T_1}_{t_0}\int_{A_p}L_i(p, p', t')|cos^4 \theta|dA_edt'dA_p
$$

自此，能量到达一个像素上，这被称为相机测量方程(Camera Measurement Equation)

尽管如此，大多数相机模型并不会模拟这种效果。(lol)

### 传感器响应建模

传统胶片是基于卤化银晶体在光照下产生溴化银的化学过程。
卤化银主要对蓝光敏感，但如果使用多层晶体，在晶体之间加上彩色滤光片，再加上能使卤化银对其他波长更敏感的染料，就能拍摄出彩色图像。

现代数码相机使用 CCD 或 CMOS 传感器，每个像素通过将光子转化为电荷，有效地计算出所受光子的数量。目前已开发出多种捕捉彩色图像的方法，但其中最常见的是在每个像素上安装彩色滤光片，这样每个像素就只能通过计算穿过滤光片的光子来测量红色、绿色或蓝色。每个像素通常都配有一个微型透镜，以增加到达传感器的光量。

对于胶片和数字传感器，像素的颜色测量可以使用光谱响应曲线来建模，该曲线表征了滤色片或胶片对光的化学响应，作为波长的函数。相关知识在色彩空间那一部分说的很详尽了：

$$
r = \int s(\lambda)\hat{r}(\lambda) d\lambda
$$

由于人类视觉系统对绿色更为敏感，因此数字传感器像素通常以马赛克(mosaic)形式排列，其中绿色像素是红色和蓝色像素的两倍。
像素马赛克的一个含义是，必须使用去马赛克算法将这些传感器像素转换成红、绿、蓝三色分量共存的图像像素。由于组成传感器像素的位置略有不同，因此采用四边形马赛克像素并使用其颜色值的简单方法效果并不好。

设计数字传感器面临着许多挑战，其中大部分挑战来自于像素的小尺寸，这是对高分辨率图像的需求所造成的。像素越小，在镜头和曝光时间内受到的光子就越少，反过来就越难精确测量光线。像素阵列会受到各种类型的噪声影响，其中拍摄噪声通常是最大的噪声。这是由于光子的离散性造成的：被计算的光子数量存在随机波动，捕捉到的光子数量越少，这种波动就越大。

在上一节中，我们可以看到像素捕捉到的能量取决于入射辐射度、像素面积、出瞳面积和曝光时间。
在给定的相机设计中，像素面积是固定的，增加镜头光圈面积和延长曝光时间都可能会带来不必要的副作用，以换取额外的光线。光圈越大，景深越小，可能导致不希望出现的虚焦模糊。
较长的曝光时间也会因场景中移动的物体或快门打开时相机的移动而导致模糊。因此，传感器和胶片以ISO设置的形式提供了额外的控制。

对于物理胶片而言，ISO表示胶片对光线的反应能力（ISO值越高，记录图像所需的光线越少）。在数码相机中，ISO控制着增益——从传感器读取像素值时应用于像素值的缩放因子。
在物理相机中，增益的增加会加剧噪点，因为初始像素测量值中的噪点被放大了。由于pbrt并不模拟物理传感器读数中存在的噪点，因此可以任意设置ISO值，以获得所需的曝光。

在 pbrt 的传感器模型中，我们既没有模拟马赛克或噪声，也没有模拟其他效应，如"Spill Over"，即像素受到足够的光线照射后会"溢出"，并开始增加相邻像素的测量值。我们也没有模拟从传感器读取图像的过程：许多相机使用滚动快门，扫描线是连续读取的。对于有快速移动物体的场景，这可能会产生令人惊讶的结果。

PBRT通过PixelSensor类模拟三个效果：

* 曝光控制：这些是用户可设置的参数，用于控制图像的亮度或暗度。
* RGB响应：PixelSensor使用基于物理相机传感器测量结果的光谱响应曲线来模拟光谱辐射到三基色的转换。
* 白平衡：照相机通常会对所拍摄的图像进行处理，包括根据光照颜色调整初始RGB值，以模拟人类视觉系统中的色度适应。因此，拍摄的图像在视觉上与人类观察者在拍照时所看到的相似。

该类通过将RGB匹配函数和成像比作为参数，同时它还需要用户为最终输出的RGB值所要求的色彩空间，以及指定场景中白色为何种颜色的光源光谱；这些参数结合在一起，就能将光谱能量转换为传感器测量的RGB值        ，然后再转换为输出色彩空间中的 RGB值。

颜色空间的转换在虎书的Chapter.19中也说的很详尽，总体来说，将RGB转化为XYZ空间作为中转方便进一步转化为所需的其他目标空间，一般来说通过一个表述颜色空间特征的3X3矩阵，可以很快将RGB空间转换为XYZ：

$$
M \begin{bmatrix}
  r_1 & r_2 &   &r_n \\
  g_1 & g_2 &  ... &g_n \\
  b_1 & b_2 &   &b_n \\
\end{bmatrix} \approx \begin{bmatrix}
  x_1 & x_2 &   &x_n \\
  y_1 & y_2 &  ... &y_n \\
  z_1 & z_2 &   &z_n \\
\end{bmatrix}
$$

只要有三个以上的反射率，这是一个可以用线性最小二乘来解决的过度约束问题。

## 反射模型

本章定义了一组用于描述光在表面散射方式的类。
表面反射模型由以下几部分组成：

* 测量数据：实验室已测量了许多真实世界表面的反射分布特性。这些数据可以直接以表格形式使用，或用于计算一组基函数的系数。
* 现象学模型：试图描述真实世界表面质量特性的方程可以非常有效地模拟真实世界的表面。这些类型的 BSDF 特别易于使用，因为它们往往具有改变其行为的直观参数（如 "粗糙度Roughness"）。
* 模拟：有时，关于表面组成的低级信息是已知的。例如，我们可能知道油漆是由悬浮在介质中的某种平均大小的彩色颗粒组成的，或者某种织物是由具有已知反射特性的两种线组成的。在这种情况下，预处理可以模拟光线在微观结构中的行为，以符合近似的 BSDF。或者，也可以在渲染时进行模拟。
* 物理（波）光学：一些反射模型是使用详细的光模型推导出来的，将光视为波，并计算麦克斯韦方程组的解，以了解光如何从具有已知特性的表面散射。这些模型主要用于包含微米级几何细节的场景，使波光学行为一目了然。

此外，BRDF和BTDF只对单点进出表面的光散射进行明确建模。对于表现出有意义的次表层光传输的表面，有必要对材料内部的光散射进行更完整的模拟--例如，PBRT Chapter.14中的体积光传输算法。

比较产生的视觉效果，我们将反射分为以下四大类:漫反射(diffuse)、光滑镜面反射(glossy specular)、完美镜面反射(perfect specular)和反反射(retroreflective)。大多数真实的表面都表现出这四种行为的混合。
漫射表面向各个方向均匀地散射光。虽然完美的漫射表面在物理上是无法实现的，但近似漫射表面的例子包括暗淡的黑板和哑光油漆。
有光泽的镜面，如塑料或高光泽的油漆，会优先将光散射在一组反射方向上——它们会显示出其他物体的模糊反射。
完美的镜面散射入射光在单一的出射方向。镜子和玻璃是完美镜面的例子。
最后，像天鹅绒或月球这样的反向反射表面主要沿着入射方向散射光。

给定某一类反射，反射分布函数可以是各向同性的，也可以是各向异性的。对于各向同性材料，如果在表面上选择一个点，并在该点绕其法向轴旋转，在该点反射的光的分布不会改变。由于木材纤维或油漆颗粒的方向随机排列，纸张或墙壁涂料等漫射材料通常是各向同性的。
相反，各向异性材料在以这种方式旋转时反射不同数量的光。各向异性材料的例子包括头发和许多种类的布料。
 铣削、轧制、挤压和3D打印等工业过程也倾向于产生高度各向异性的表面，一个极端的例子是拉丝金属。

### 几何设定和约定俗成

反射坐标系，两条垂直向量和一条法线向量组成坐标系的三条轴，传递给BxDF计算以及采样的例程都是通过该坐标系定义。

在BSDF坐标系中，**检查两个方向向量相对于表面法线是否在同一个半球**：

```cpp
bool SameHemisphere(Vector3f w, Vector3f wp) {
    return w.z * wp.z > 0;
}
```

其次，入射光线方向$\omega_i$和出射视线方向$\omega_o$在转换到表面的本地坐标系后都将归一化并朝外。换句话说，这些方向不会模拟光线的物理传播，这对以相反顺序生成光路的双向渲染算法很有帮助。
在pbrt中，表面法线n总是指向物体的外部，这易于判断光线是否进入或者离开投射物体，如果入射方向与n在同一半球，则说明光线进入，反之则说明光线退出。PBRT不会将法线翻转到与$\omega_o$同一侧。

### 使用辐射积分

