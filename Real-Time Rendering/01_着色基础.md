# 着色基础

## 着色模型

着色模型用于描述物体的颜色如何随着表面朝向、观察方向和光照等因素而变化。

Gooch模型：一种常用于增加技术插图细节易读性的模型。

$$
\bold{c}_{shaded} = s\bold{c}_{highlight} + (1-s)(t\bold{c}_{warm} + (1-t)\bold{c}_{cool})
$$

$$
\begin{aligned}
\bold{c}_{cool} &= (0, 0, 0.55) + 0.25\bold{c}_{surface},\\
\bold{c}_{warm} &= (0.3, 0.3, 0) + 0.25\bold{c}_{surface},\\
\bold{c}_{highlight} &= (1, 1, 1),\\
t &= \frac{(\bold{n}\cdot\bold{l}) + 1}{2},\\
\bold{r} &= 2(\bold{n}\cdot\bold{l})\bold{n} - \bold{l},\\
s &=(100(\bold{r}\cdot\bold{v})-97)^\mp
\end{aligned}
$$

$t\bold{c}_{warm} + (1-t)\bold{c}_{cool}$用于表示在两个颜色之间使用0-1的标量进行一个线性的插值。
$\bold{r}$是一个很常见的用法，表示求对于入射$\bold{l}$与表面法线(单位向量)$\bold{n}$形成的反射角。
$\bold{v}$用于表示观察光线，由物体表面出射到摄像机点。

## 光源

多光源的表面光照模型：

$$
\bold{c}_{shaded} = f_{unlit}(\bold{n}, \bold{v}) + \sum^n_{i=1} (\bold{l}_i \cdot \bold{n})^+\bold{c}_{light}f_{lit}(\bold{l}_i, \bold{n}, \bold{v})
$$

当$f_{lit}() = \bold{c}_{surface}$时，这个公式就是朗伯着色模型。

### 方向光

对于方向光，其光线方向和$\bold{l}$和颜色$\bold{c}_{light}$都是恒定的。

#### 点光源

用于表示向所有方向都均匀发射光线的精确光源(point light/omni light)。其性质为光线强度$\bold{c}_{light}$会随着距离r的变化而变化。
对于一个给定的表面，一个点光源发出的光线，其间距与光源到表面的距离成正比。

假定在参考距离$r_0$处的光照参数$\bold{c}_{light_0}$，基于此我们假设在$r$处的光线强度为：

$$
\bold{c}_{light}(r) = \bold{c}_{light_0}(\frac{r_0}{r})^2
$$

通常被称为光线的平方反比衰减方程，可以看出该方程的思想和irradiance的计算有异曲同工之妙。

对于该公式的改进主要是两方面：

* 考虑问题发生在较小距离时，光照强度可能会迅速无界增长到一个可怕的数值，因此可以考虑给分母添加一个较小的数值，限制放大的最大幅度：

$$
\bold{c}_{light}(r) = \bold{c}_{light_0}(\frac{r_0}{r+\epsilon})^2
$$

通过$\max()$直接限制，也是一样的思路。

* 在较大的距离上，光线强度会随着距离的增大无限趋近于0，但其不会等于0。从优化角度当希望在合适的程度衰减到0，通过窗函数完成修正，达成函数的导数和函数值在同一位置达到0：

$$
f_{win}(r) = (1 - (\frac{r}{r_{max}})^4)^{+2}
$$

$+2$意味着在平方计算之前，保证底数大于等于0.

#### 聚光灯

现实世界中⼏乎所有光源的光照，不仅会随着距离的改变⽽发⽣变化，同样也会随着⽅向的改变⽽发⽣变化，这种变化可以表示为⼀个⽅向性的衰减：

$$
\bold{c}_{light} = \bold{c}_{light_0}\bold{f}_{dist}(r)\bold{f}_{dir}(\bold{l})
$$

$\bold{f}_{dir}(\bold{l})$表示方向上的衰减，这也同样体现了辐射度量学中的radiance思想。这里提到方向衰减的原因在于聚光灯在其方向向量一定的夹角$\theta_u$(umbra angle)范围内具有固定的光照强度，而在其之外则有一定程度的衰减，在本影角(penumbra angle)$\theta_p$之外，强度降至0。
现在我们将这个概念量化，假定光线方向角$\theta_s$：

$$
t = (\frac{\cos\theta_s - \cos\theta_u}{\cos\theta_p - \cos\theta_u})^\mp \\
\begin{aligned}
f_{dir_F}(\bold{l}) &= t^2 \\
f_{dir_T}(\bold{l}) &= smoothstep(t) = t^2(3 - 2t)
\end{aligned}
$$
F代表寒霜引擎，T代表three.js

## 实现着色模型

设计一个着色实现时，首先需要评估计算频率(frequency of evaluation)，如果可以在常数复杂度级别内完成，那么就交给cpu去完成，然后传递给图形API以减少重复计算量。甚至一些计算不需要传递给着色器输入。

每帧需要计算一次的，例如视角变换和透视变换；再如每个模型一次的计算，对依赖于模型位置的光照参数进行更新。根据计算频率对着色器输入进行分组，以提高计算的效率。

## 锯齿和反锯齿

* 采样

当采样频率远低于运动频率时，出现时域走样(temporal aliasing)。
采样定理：采样率必须要在采样信号最大频率的两倍以上。对应的采样率叫作奈奎斯特率或奈奎斯特极限。

* 重建

采样成离散数据后，就要进行重建，这部分在虎书里已经有了比较详细的介绍。例如通过box滤波器，tent滤波器和sinc滤波器进行重建，sinc滤波器是一种理想的低通滤波器，但会造成一些区域为负。相反，非负波瓣的滤波器被称为高斯滤波器，被广泛利用于工业中。

然而，在得到一个连续的信号后，并不能直接显示这样的连续信号，因为图形学的最终目的，是为了在屏幕上显示出离散的像素点。

* 重采样

