# chapter-04 Ray Tracing

基本的光线追踪流程：

1. 光线生成，其基于相机几何形状计算每个像素的观看光线的原点和方向；
2. 光线相交，用于查找与查看光线相交的最近对象；
3. 着色，根据光线相交的结果计算像素颜色。

## 视角射线

射线由一个原点和一个传播方向组成，从视角点e射出一条射线：

$p(t) = e + t(s-e)$

可以被解释为`沿着向量(s-e)一个分数距离t前进以找到点p`

* 关于相机的向量
相机的向量由uvw三个轴组成，v代表向上的方向，u代表右手方向，而w方向指向观察者，
对于正交视图，所有光线都将具有方向-w

## ray-object intersection

一旦我们生成了一条射线$e+td$，我们接下来需要找到与$t > 0$的任何对象的第一个交点。

### 射线-球面相交

给定一个射线$p(t) = e + td$和一个隐式表面$f (p) = 0$
需求：

$$
f (e + td) = 0
$$

对于球面，有方程
$$
(x − x_c)^2 + (y − y_c)^2 + (z − z_c)^2 − R^2 = 0
$$

当满足：
$$
(p − c) · (p − c) − R^2 = 0
$$
我们可以说满足点p在球面上，也就是：
$$
(e + td − c) · (e + td − c) − R^2 = 0
$$

问题聚焦于如何求解t，于是化解成一元二次方程：
$$
(d · d)t^2 + 2d · (e − c)t + (e − c) · (e − c) − R^2 = 0.
$$
类似于：
$$
At^2 + Bt + C = 0.
$$

有：
$$
t = \frac {−d · (e − c)\pm\sqrt{(d · (e − c))2 − (d · d) ((e − c) · (e − c) − R^2)}}{(d · d)}
$$

### 射线-三角形相交

有许多计算射线三角形交点的算法。我们将给出对包含三角形的参数平面使用重心坐标的形式，因为它除了三角形的顶点之外不需要长期存储，只需要存储三角形的三个顶点。

$$
\begin{cases}
x_e + tx_d = f(u, v) \\
y_e + ty_d = g(u, v) \\
z_e + tz_d = h(u, v)
\end{cases}
$$
也就是：
$$
e + td = f (u, v).
$$

假设三角形的三个顶点a,b,c.有：
$$
e + td = a + β(b − a) + γ(c − a)\\
β > 0, γ > 0, and\ β + γ < 1
$$

可以说射线存在一点相较于三角形区域内，为了解决等式中的 t、β 和 γ，我们将其向量形式扩展为三个坐标的三个方程，并根据克莱默法则：

对于线性方程组：

$$
\begin{bmatrix}
x_a - x_b & x_a - x_c & x_d \\
y_a - y_b & y_a - y_c & y_d \\
z_a - z_b & z_a - z_c & z_d
\end{bmatrix}\begin{bmatrix}
β\\
γ\\
t
\end{bmatrix} = \begin{bmatrix}
x_a - x_e\\
y_a - y_e\\
z_a - z_e
\end{bmatrix}
$$

有解:

$$
β = \frac{\begin{vmatrix}
x_a - x_e & x_a - x_c & x_d \\
y_a - y_e & y_a - y_c & y_d \\
z_a - z_e & z_a - z_c & z_d
\end{vmatrix}}{|A|},
$$
$$
γ = \frac{\begin{vmatrix}
x_a - x_b & x_a - x_e & x_d \\
y_a - y_b & y_a - y_e & y_d \\
z_a - z_b & z_a - z_e & z_d
\end{vmatrix}}{|A|} ,
$$
$$
t = \frac{\begin{vmatrix}
x_a - x_b & x_a - x_c & x_a - x_e \\
y_a - y_b & y_a - y_c & y_a - y_e \\
z_a - z_b & z_a - z_c & sz_a - z_e
\end{vmatrix}}{|A|}
$$

### 射线多边形相交

给定一个平面多边形，其中m个顶点$p_1$到$p_m$，表面法线n，我们首先计算射线e + td与包含具有隐式方程的多边形的平面的交点

$$
(p − p_1) · n = 0
$$

易得：

$$
t = \frac{(p_1 - e) · n}{d·n}
$$

我们可以通过将点和多边形顶点投影到xy平面上并在那里回答它来回答p是否在多边形内的问题。
这样做的最简单方法是从p发送任何2D射线并计算该射线与多边形边界的交点数:如果交点数为奇数，则该点在多边形内；否则不是。

## Shading

### Lambertian Shading

Lambert在18世纪的一项观测:光源照射在表面区域的能量取决于表面与光的角度。

1. 直接面向光的表面接收最大照明；
2. 与光方向相切（或背对光）的表面不接收照明；
3. 照明与表面法线和光源之间的角度θ的余弦成比例。

这也是blinn-Phong着色中漫反射的设计。

公式：

$$
L = k_d I max(0, n · l)
$$

其中L是像素颜色；kd是漫射系数，或表面颜色；I是光源的强度。
该方程分别适用于三个颜色通道，因此像素值的红色分量是红色漫射分量、红色光源强度和点积的乘积；绿色和蓝色也是如此。

### Blinn-Phong Shading

通过将半矢量h（v和l之间角度的平分线）与表面法线进行比较来判断相机离镜面配置有多近。
n和h也同样是单位向量

$$
h = \frac{v+l}{||v+l||}
$$

$$
L = k_d I max(0, n · l) + k_s I max(0, n · h)^p
$$

### Ambient Shading

为了便于调整参数，环境着色通常表示为表面颜色与环境光颜色的乘积，因此可以单独调整表面的环境着色，也可以一起调整所有表面的环境阴影。
环境光着色与Blinn Phong模型的其余部分一起完成了简单实用的着色模型的完整版本：

$$
L = k_a I_a + k_d I max(0, n · l) + k_s I max(0, n · h)^n
$$

$k_a$是曲面的环境系数或“环境颜色”，$I_a$是环境光强度。

### 多点光源

$$
L = k_a I_a + \sum_{i=1}^{N} [k_d I_i max(0, n · l_i) + k_s I_i max(0, n · h_i)^p]
$$

## 阴影

以后再说。

## 镜面反射

将理想的镜面反射或镜面反射添加到光线跟踪程序中非常简单。
捕捉映射在镜面上的光线，相当于在反射点，以视角射线被反射出去的方向进行拍摄：

$$
r = d − 2(d · n)n
$$

在现实世界中，当光从表面反射时，会损失一些能量，而这种损失对于不同的颜色可能不同。例如，金色比蓝色更有效地反射黄色，因此它会改变所反射对象的颜色。这可以通过在`raycolor`中添加递归调用来实现：

$$
color\ c = c + k_mraycolor(p + sr, ε , ∞)
$$

$k_m$（表示“镜面反射”）是镜面RGB颜色。

递归调用的问题是它可能永远不会终止，可以通过添加最大递归深度来解决。
