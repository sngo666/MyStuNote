# 使用外部链接库

* 关于链接库

链接库是一种文件，包含了已经汇编为机器代码的过程（子程序）。链接库在开始时是一个或多个源文件，这些文件再被汇编为目标文件插入到一个特殊文件中，该文件由链接器工具识别。
当一个程序调用过程`WriteString`在控制台窗口显示字符串时，该程序源代码必须包含PROTO伪指令标识WriteString过程。
> `WriteString proto`

在这之后，可以使用call指令执行WriteString过程。
> `call WriteString`

使用命令将一个程序的目标文件与一个或多个目标文件以及链接库组合在一起，如：
> `link hello.obj irvine32.lib kernel32.lib`

文件句柄：文件句柄是一个32位整数，操作系统用它来标识当前打开的文件。当用户程序调用一个windows服务来打开或者创建文件时，操作系统就创建一个新的文件句柄，并使其对用户程序可用，每当用户程序调用OS服务方法来读写该文件时，就必须将这个文件句柄作为参数传递给服务方法。

* irvine32链接库

1. CloseFile
该过程关闭之前已经创建或者打开的文件，该文件用一个32位句柄来表示，句柄由EAX传递。文件成功关闭时，EAX中的返回值就是非0的。格式如下：
>
> ```asm
> mov eax, fileHandle
> call CloseFile
> ```

2. Clrscr
该过程用以清除窗口，通常在程序开始和结束时被调用，如果在其他时间调用这个过程，就要先调用WaitMsg来暂停程序。格式如下：

> ```asm
> call WaitMsg       ;"press any key..."
> call Clrscr  
> ```

3. CreateOutputFile
该过程创建并打开一个新的磁盘文件，进行写操作。调用该过程中时，将文件的偏移量送入EDX。过程返回后，如果文件创建成功则EAX将包含一个有效的文件句柄。否则EAX将包含一个预定的常数(INVALID_HANDLE_VALUE)

> ```asm
> .data
> filename BYTE "newfile.txt"
> .code 
> mov edx, OFFSET filename
> call CreateOutputFile
> ```

4. Crlf
该过程将光标定位在控制台窗口的下一行的开始位置，这一过程中输入包含了0Ah和0Dh。

5. Delay
根据EAX中的预定值，按照特定毫秒数暂停程序。

6. DumpMan
该过程在控制台中以十六进制形式显示一段内存区域。使用ESI存放内存区域首地址，ECX存放的是单元个数；EBX存放的是单元大小（1=字节，2=字， 4=双字）。

7. DummpRegs
该过程以十六进制形式显示EAX，EBX，ECX，EDX，ESI，EDI，EBP，ESP，EIP和EFLAGS的内容，以及进位标志位，符号标志位，零标志位，溢出标志位，辅助进位标志位和奇偶标志位的值。
其中EIP显示的是调用本过程的下一条指令的偏移量。

8. GetCommandTail
该过程将程序命令行复制到一个空字节结束的字符串，如果命令行是空的，则进位标志位置1；否则进位标志位清零。该过程的实际作用在于能够让程序用户获取命令行指令中的参数。格式如下：

> ```asm
> .data
> CommandTail BYTE 129 DUP(0)
> .code 
> mov edx, OFFSET CommandTail
> call GetCommandTail
> ```

9. GetMaxXY
本过程获取控制台窗台缓冲区的大小，如果控制台缓冲区大于可视窗口尺寸，则显示滚动条，本过程没有输入参数，当返回值时，DX寄存器包含了缓冲区的列数，AX包含了行数，每个数值的可能范围不超过255。

10. GetMseconds
本过程获取主机从午夜开始经过的毫秒数，并用EAX返回该值。用于计算程序执行时间。

11. GetTextColor
本过程获取控制台窗口当前的前景色和背景色，返回时，AL高四位是背景色，低四位是前景色。

12. Gotoxy
本过程将光标定位到控制台窗口的指定位置，默认情况下，控制台窗口的x轴范围是0~79，y轴范围是0~24，使用DH寄存器预先存储Y轴，DL寄存器存储X轴。

13. IsDigit
本过程确定AL中的数值是否是一个有效十进制代码的ASCII码，如果是，则将零标志位置1。否则将零标志位清零。

14. MsgBox
本过程显示一个带选择项的图形界面弹出消息框。过程用EDX传递一个字符串的偏移量，并在消息框中显示该字符串。并可以使用EBX存储一个字符串变量的偏移量，用以显示消息框的标题，如果标题为空，则EBX为0。

15. MsgBoxAsk
本过程用以弹出一个带有yes和no选择的图形弹出消息框，使用EDX传递问题字符串的偏移量，使用EBX传递消息框标题字符串的偏移量，如果标题为空，则EBX为0。消息框使用EAX存储并返回用户选择的按钮：IDYES（值为6）或IDNO（值为7）。

16. OpenInputFile
本过程打开一个已经存在文件并进行输入，输入输出情况与CreateInputFile相类似。

17. ParseDecimal32
本过程将一个无符号十进制整数字符串转换为32位二进制数。非数字符号之前所有的有效数字都要转，前导空格忽略。过程使用EDX传递字符串的偏移量，用ECX传递字符串的长度，用EAX返回二进制数值。

> 如果整数为空，eax = 0且 cf = 1。  
> 如果整数只有空格，eax = 0且 cf = 1。  
> 如果整数大于（2^32-1）,eax = 0且 cf = 1。  
> 否则，eax为转换后的数，且cf = 0.

18. ParseInteger32
本过程将一个有符号十进制整数字符串转换为32位进制数，类似于PaeseDecimal32，如果数值不能表示为32位有符号整数，则溢出标志位置1。

19. Random32
本过程用以生成一个随机32位整数并用EAX并返回该数。

20. Randomize
Randomize对于Random32和RandomRange过程的第一个种子进行初始化，种子等于一天中的时间，时间精度为1/100秒，本过程只需要在程序开头调用一次，每当调用Random和RandomRange时产生的随机数序列都不一样。

21. RandomRange
本过程在范围0~n-1内生成一个随机数，使用EAX寄存器 传递输入参数，生成的随机数也使用EAX返回。

22. ReadChar
本过程用于从键盘读取一个字符，并用AL寄存器返回，字符不在控制台窗口中回显。
如果用户按下的是非字符键，则本过程吧AL清零，并使用AH包含的是键盘扫描码。

23. ReadDec
本过程用以从键盘读取一个32位无符号十进制整数，并用EAX返回该值，前导空格忽略，返回值为遇到的第一个非数字字符之前的所有有效数字。
本过程对于进位标志位(CF)的影响请参照ParseDecimal32。

24. ReadFromFile
本过程读取存储缓冲区中的一个输入磁盘文件。调用本过程时，使用EAX打开文件的句柄，使用EDX传递缓冲区的偏移量，用ECX传递读取的最大字节数。
返回时需要查看进位标志位的值，若CF值为0，则EAX包含了从文件读取的字节数，若CF置1，则EAX包含了数字系统错误代码，调用WriteWindowsMsg可查看该错误代码。

25. ReadHex
使用本过程从键盘读取一个32位十六进制整数，并用EAX返回相应的二进制数，对无效字符不作任何的检查，最多能够输入八个数字（超出部分忽略）。

26. ReadInt
从键盘读取一个32位有符号整数，并用EAX返回该值，用户可以键入前置的加号或者减号，而后面跟着的只能是数字，如果输入的数字不在科表示的范围内，则显示一个错误信息。

27. ReadKey
此过程执行无等待键盘检查。也就是说，它检查键盘输入缓冲区以查看用户是否有按键操作。没有时将零标志位置1，反之则清除零标志位，且向AL送入0或ASCII码。AL为0时说明用户可能按下了特殊键，AH寄存器为虚拟扫描码，DX为虚拟键码，EBX为键盘标志位。
调用本过程会覆盖EAX和EDX的高16位。

28. ReadString
执行此过程从键盘读取一个字符串，直到用户输入回车键，过程使用EDX传递缓冲区的偏移量，用ECX传递用户能键入的最大字符数加1，用EAX返回用户键入的字符数。
ReadString在内存中的字符串的末尾自动插入一个null终止符，返回的长度不包括终止符。

29. SetTextColor、
调用本过程时，给EAX分配一个颜色属性，用以设置输出文本的前景色和背景色。

30. Str_length
本过程返回空字节结束的字符串的长度，过程使用EDX传递字符串的偏移量，用EAX返回字符串的长度。

31. WaitMsg
调用此过程显示“Press any key to continue……”并等待用户按键。

32. WirteBin
本过程以ASCII二进制形式向控制台窗口输出一个整数，过程用EAX传递该整数。二进制位以四位一组进行显示。

33. WirteBinB
本过程以ASCII二进制格式向控制台输出一个32位整数。过程用EAX寄存器传递该整数，用EDX表示以字节为单位地显示大小( 1、2或4)，二进制位以四位一组进行显示。

34. WriteChar
本过程向控制台窗口写一个字符，过程使用AL传递字符。

35. WriteDec
本过程以十进制格式向控制台窗口输出一个32位无符号整数，且没有前置0，使用EAX传递该整数。

36. WriteHex
本过程以8位十六进制格式向控制台窗口输出一个32位无符号整数，如果需要会插入前置0，过程用EAX传递该整数。

37. WriteHexB
与WriteHex相似，不过使用EBX表示显示格式的字节数（1，2或4）。

38. WriteInt
本过程以十进制格式向控制台窗口输出一个32位有符号整数，有前置符号，但是没有前置0。过程用EAX传递该整数。

39. WriteString
本过程向操作台窗口输出个空字节结束的字符串，过程使用EDX传递字符串的偏移量。

40. WriteToFile
本过程向一个输出文件写入缓冲区内容，过程使用EAX传递有效的文件句柄，用EDX传递缓冲区偏移量，用ECX传递写入的字节数。当过程返回时，若EAX大于0，则其为写入的字节数，否则发生了错误。

41. WriteWindowsMsg
本过程向控制台窗口输出应用程序在调用系统函数时最近产生的错误信息。

&emsp;

* x64调用规范

1. CALL指令将RSP寄存器减8，因为地址是64位的。
2. 前四个参数依次存入RCX、RDX、R8和R9。
3. 调用者的责任还包括在运行时堆栈分配至少32字节的影子空间，使被调用过程选择将寄存器参数保存在这个区域。
4. 在调用子程序时，RSP必须进行16位字节边界对齐(16的倍数)，因此CALL指令把8字节的返回值压入堆栈，所以总共要从堆栈指针减去40字节。

* 关于16字节对齐问题
  
转自<https://blog.csdn.net/bp_send/article/details/126276848>
代码走到CALL指令时，rsp栈指针其实是以0为末位的，进入函数体后，栈指针向下移，末位为8，执行完成代码之后还是0结尾。
也就是说，对齐的栈地址必须以0结尾。